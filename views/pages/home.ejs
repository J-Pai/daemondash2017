<!-- views/pages/home.ejs -->
<!DOCTYPE html>

<html lang="en">
    <head>
        <% include ../partials/head %>
        <link rel="stylesheet" href="/public/css/home.css">
        <link rel="stylesheet" href="/public/css/custTimetable.css">        
        <link rel="stylesheet" href="/public/timetable.js-master/dist/styles/timetablejs.css">
        <script src="/public/timetable.js-master/dist/scripts/timetable.min.js"></script>
        <script src="/socket.io/socket.io.js"></script>
    </head>
    <body class="container-fluid">
        <% include ../partials/header %>
        <main>
            <div class="row vertical-aligned">
                <div class="col-md-3">
                    <div class="well">
                        <label>
                            Search building name here: 
                        </label>
                        <div class="input-group input-group-lg search-field">
                            <span class="input-group-btn">
                                <button class="btn btn-default" type="button" 
                                        id="search-button">
                                        Go!
                                </button>
                            </span>
                            <input id="search-field" list="building-list" type="text"        placeholder="Search here..." class="form-control">
                        </div>
                        <datalist id="building-list"></datalist>
                    </div>
                </div>

                <div class="col-md-9">
                    <div class="well">
                        <div class="text-center">
                            <h1 class="customTitle" id="timetable-title"></h1>
                        </div>
                        <div class="timetable pre-scrollable"></div>
                    </div>
                    <div class="well" id="booking-detail"> 
                        <h2 class="customTitle">Booking details</h2>
                        <div id="timetable-detail"></div>
                    </div>
                </div>
            </div>
        </main>
        <% include ../partials/footer %>
        <script>
            //Populate .json into datalist

            var io = io();
            var options = [];
            io.on('set rooms', function(rooms) {
                console.log(rooms);
            });

            $.getJSON("/public/json/buildings.json", function(data) {
                Object.keys(data).forEach(function(building) {
                    options.push("(" + data[building].code + ") " + data[building].name);
                });
                for (var i = 0; i < options.length; i++) {
                    var option = document.createElement('option');
                    option.value = options[i];
                    $('#building-list').append(option);
                }
            });

            //New timetable
            var timetable = new Timetable();
            timetable.setScope(0, 23);
            timetable.addLocations (['Room 1', 'Room 2', 'Room 3', 'Room 4', 'Room 5', 'Room 6', 'Room 7', 'Room 8', 'Room 9', 'Room 10', 'Room 11', 'Room 12', 'Room 13', 'Room 23', 'Room 33', 'Room 43', 'Room 53', 'Room 63', 'Room 73', 'Room 83', 'Room 31', 'Room 32', 'Room 35', 'Room 34', 'Room 36', 'Room 37', 'Room 38', 'Room 39', 'Room 389']);

            var options1 = {
                class: 'class',
                data: {

                }
            }

            var options2 = {
                url: '#',
                class: 'free',
                data: {
                    room: 'Room 2',
                    date: '2015/7/17',
                    time: '10:45am - 11:00am',
                    id: 10451100,
                }
            }

            var options4 = {
                url: '#',
                class: 'free',
                data: {
                    room: 'Room 2',
                    date: '2015/7/18',
                    time: '11:00am - 11:20am',
                    id: 11001120,
                }
            } 

            var options3 = {
                class: 'taken',
                data: {
                    id: 4,
                }
            }

            timetable.addEvent('Class', 'Room 1', 
                new Date(2015,7,17,10,45), new Date(2015,7,17,12,30), options1);
            timetable.addEvent('', 'Room 2', 
                new Date(2015,7,17,10,45), new Date(2015,7,17,11,00), options2);
            timetable.addEvent('', 'Room 2', 
                new Date(2015,7,17,11,00), new Date(2015,7,17,11,15), options4);
            timetable.addEvent('', 'Room 3', 
                new Date(2015,7,17,10,45), new Date(2015,7,17,12,30), options3); 

            var renderer = new Timetable.Renderer(timetable);
                renderer.draw('.timetable');

            //Hide booking detail
            var numOfBooking = 0;
            $(function(){
                $("#booking-detail").hide();
            })
            //Select and de-select
            $(".time-entry.free").click(function(){
                $(this).toggleClass('clicked');

                if ($(this).attr("class").indexOf("clicked") == -1) {
                    $("#" + $(this).attr("data-id")).remove();
                    numOfBooking--;
                }else {
                    var detail = document.createElement('p');
                    detail.setAttribute("id", $(this).attr("data-id"));
                    detail.innerHTML = ($(this).attr("data-room") + " " + 
                    $(this).attr("data-date"));
                    $("#timetable-detail").append(detail);
                    numOfBooking++;
                }

                if (numOfBooking == 0) {
                    $("#booking-detail").hide();                    
                }else {
                    $("#booking-detail").show();
                }
            });  

            //Search button
            $("#search-button").click(function(){
                var inputVal = $("#search-field").val();
                var obj = $("#building-list").find("option[value='"+inputVal+"']");

                if(obj !=null && obj.length>0) {
                    var code = inputVal.split(' ')[0].slice(1,-1)
                    $("#timetable-title").text(inputVal); 
                    io.emit("get building", code);
                }
                else {
                    alert("Invalid choice"); 
                }
            })
        </script>
    </body>
</html>
